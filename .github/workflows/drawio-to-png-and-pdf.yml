name: Draw.io to PNG & PDF Workflow

on:
  push:
    paths:
      - '**/*.drawio'
      - Assets/asset-config-map.yaml
      - .github/workflows/drawio-to-png-and-pdf.yml
  pull_request:
    paths:
      - '**/*.drawio'
      - Assets/asset-config-map.yaml
      - .github/workflows/drawio-to-png-and-pdf.yml

permissions:
  contents: write

concurrency:
  group: drawio-export
  cancel-in-progress: false

jobs:
  drawio-to-png-and-pdf-map:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Draw.io to PNG & PDF Workflow
        run: |
          set -e

          # Install yq for YAML parsing
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

          # Read YAML and process each conversion
          yq -r '.conversions.drawio[] | @json' ./Assets/asset-config-map.yaml | while read -r line; do
            input=$(echo "$line" | jq -r '.input')
            png=$(echo "$line" | jq -r '.png')
            pdf=$(echo "$line" | jq -r '.pdf')

            input_basename=$(basename "$input")
            input_name_no_ext="${input_basename%.drawio}"

            echo "input: $input"
            echo "png: $png"
            echo "pdf: $pdf"

            if [ -n "$png" ] && [ "$png" != "null" ]; then
              if [[ "$png" == */ ]]; then
                png_dir="${png%/}"
                png_target="$png_dir/${input_basename}.png"
              else
                png_dir="$(dirname "$png")"
                png_target="$png"
              fi

              mkdir -p "$png_dir"

              docker run --rm \
                -v "$PWD:/data" \
                rlespinasse/drawio-export \
                "$input" \
                --format png \
                --output "$png_dir"

              generated_png="$png_dir/${input_name_no_ext}-Page-1.png"
              if [ -f "$generated_png" ]; then
                mv "$generated_png" "$png_target"
              else
                echo "Expected PNG $generated_png not found"
              fi
            else
              echo "Skipping PNG export for $input (no png path configured)"
            fi

            if [ -n "$pdf" ] && [ "$pdf" != "null" ]; then
              if [[ "$pdf" == */ ]]; then
                pdf_dir="${pdf%/}"
                pdf_target="$pdf_dir/${input_basename}.pdf"
              else
                pdf_dir="$(dirname "$pdf")"
                pdf_target="$pdf"
              fi

              mkdir -p "$pdf_dir"

              docker run --rm \
                -v "$PWD:/data" \
                rlespinasse/drawio-export \
                "$input" \
                --format pdf \
                --output "$pdf_dir"

              generated_pdf="$pdf_dir/${input_name_no_ext}-Page-1.pdf"
              if [ -f "$generated_pdf" ]; then
                mv "$generated_pdf" "$pdf_target"
              else
                echo "Expected PDF $generated_pdf not found"
              fi
            else
              echo "Skipping PDF export for $input (no pdf path configured)"
            fi

            tree

          done


      # - name: Commit files
      #   uses: stefanzweifel/git-auto-commit-action@v5
      #   with:
      #     commit_message: Automatically converted all .drawio files to PNG and PDF and committed the results
      #     commit_user_name: ${{ vars.COMMIT_USER_NAME }}
      #     commit_user_email: ${{ vars.COMMIT_USER_EMAIL }}
      #     commit_author: ${{ vars.COMMIT_AUTHOR }}
      #     push_options: '--force'
