name: Draw.io to PNG & PDF Workflow

on:
  push:
    paths:
      - '**/*.drawio'
      - Assets/asset-config-map.yaml
      - .github/workflows/drawio-to-png-and-pdf.yml
  pull_request:
    paths:
      - '**/*.drawio'
      - Assets/asset-config-map.yaml
      - .github/workflows/drawio-to-png-and-pdf.yml

permissions:
  contents: write

concurrency:
  group: drawio-export
  cancel-in-progress: false

jobs:
  drawio-to-png-and-pdf-map:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Draw.io to PNG & PDF Workflow
        run: |
          set -e

          # Install yq for YAML parsing
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

          # Read YAML and process each conversion
          yq -r '.conversions.drawio[] | @json' ./Assets/asset-config-map.yaml | while read -r line; do
            input=$(echo "$line" | jq -r '.input')
            png=$(echo "$line" | jq -r '.png // "null"')
            pdf=$(echo "$line" | jq -r '.pdf // "null"')

            echo "Processing: $input"
            echo "PNG config: $png"
            echo "PDF config: $pdf"

            # Get the base filename from input (without path)
            input_basename=$(basename "$input")
            # Strip .drawio extension if present
            input_basename_no_ext="${input_basename%.drawio}"
            # Get the directory containing the input file
            input_dir=$(dirname "$input")

            # Process PNG if configured
            if [ "$png" != "null" ] && [ -n "$png" ]; then
              # If png ends with /, it's a directory - append the filename
              if [[ "$png" == */ ]]; then
                # Resolve the output directory path relative to input directory
                png_dir=$(cd "$input_dir" && realpath "$png")
                png_output="${png_dir}/${input_basename_no_ext}.png"
              else
                # Resolve the full output path relative to input directory  
                png_output=$(cd "$input_dir" && realpath "$png")
              fi
              
              # Convert to relative path from PWD for docker
              png_output_rel=$(realpath --relative-to="$PWD" "$png_output")
              
              mkdir -p "$(dirname "$png_output")"
              echo "Converting to PNG: $png_output_rel"
              docker run --rm \
                -v "$PWD:/data" \
                rlespinasse/drawio-export \
                "$input" \
                --format png \
                --output "$png_output_rel"
            else
              echo "PNG config not specified, skipping PNG conversion"
            fi

            # Process PDF if configured
            if [ "$pdf" != "null" ] && [ -n "$pdf" ]; then
              # If pdf ends with /, it's a directory - append the filename
              if [[ "$pdf" == */ ]]; then
                # Resolve the output directory path relative to input directory
                pdf_dir=$(cd "$input_dir" && realpath "$pdf")
                pdf_output="${pdf_dir}/${input_basename_no_ext}.pdf"
              else
                # Resolve the full output path relative to input directory
                pdf_output=$(cd "$input_dir" && realpath "$pdf")
              fi
              
              # Convert to relative path from PWD for docker
              pdf_output_rel=$(realpath --relative-to="$PWD" "$pdf_output")
              
              mkdir -p "$(dirname "$pdf_output")"
              echo "Converting to PDF: $pdf_output_rel"
              docker run --rm \
                -v "$PWD:/data" \
                rlespinasse/drawio-export \
                "$input" \
                --format pdf \
                --output "$pdf_output_rel"
            else
              echo "PDF config not specified, skipping PDF conversion"
            fi

            tree

          done

      # - name: Commit files
      #   uses: stefanzweifel/git-auto-commit-action@v5
      #   with:
      #     commit_message: Automatically converted all .drawio files to PNG and PDF and committed the results
      #     commit_user_name: ${{ vars.COMMIT_USER_NAME }}
      #     commit_user_email: ${{ vars.COMMIT_USER_EMAIL }}
      #     commit_author: ${{ vars.COMMIT_AUTHOR }}
      #     push_options: '--force'
