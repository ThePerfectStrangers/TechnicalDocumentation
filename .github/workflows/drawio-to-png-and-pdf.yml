name: Draw.io to PNG & PDF Workflow

on:
  push:
    paths:
      - '**/*.drawio'
      - Assets/asset-config-map.yaml
  pull_request:
    paths:
      - '**/*.drawio'
      - Assets/asset-config-map.yaml

permissions:
  contents: write

concurrency:
  group: drawio-export
  cancel-in-progress: false

jobs:
  drawio-to-png-and-pdf-map:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Draw.io to PNG & PDF Workflow
        run: |
          set -e

          # Install yq for YAML parsing
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

          # Read YAML and process each conversion
          yq -r '.conversions.drawio[] | @json' ./Assets/asset-config-map.yaml | while read -r line; do
            input=$(echo "$line" | jq -r '.input')
            png=$(echo "$line" | jq -r '.png')
            pdf=$(echo "$line" | jq -r '.pdf')

            mkdir -p "$(dirname "$png")"
            mkdir -p "$(dirname "$pdf")"

            docker run --rm \
              -v "$PWD:/data" \
              rlespinasse/drawio-export \
              "$input" \
              --format png \
              --output "$png"

            docker run --rm \
              -v "$PWD:/data" \
              rlespinasse/drawio-export \
              "$input" \
              --format pdf \
              --output "$pdf"

            tree

          done

      # - name: Commit files
      #   uses: stefanzweifel/git-auto-commit-action@v5
      #   with:
      #     commit_message: Automatically converted all .drawio files to PNG and PDF and committed the results
      #     commit_user_name: ${{ vars.COMMIT_USER_NAME }}
      #     commit_user_email: ${{ vars.COMMIT_USER_EMAIL }}
      #     commit_author: ${{ vars.COMMIT_AUTHOR }}
      #     push_options: '--force'
