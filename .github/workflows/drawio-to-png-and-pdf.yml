name: Draw.io to PNG & PDF Workflow

on:
  push:
    paths:
      - '**/*.drawio'
      - Assets/asset-config-map.yaml
      - .github/workflows/drawio-to-png-and-pdf.yml
  pull_request:
    paths:
      - '**/*.drawio'
      - Assets/asset-config-map.yaml
      - .github/workflows/drawio-to-png-and-pdf.yml

permissions:
  contents: write

concurrency:
  group: drawio-export
  cancel-in-progress: false

jobs:
  drawio-to-png-and-pdf-map:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Draw.io to PNG & PDF Workflow
        run: |
          set -e

          # Install yq for YAML parsing
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

          # Read YAML and process each conversion
          yq -r '.conversions.drawio[] | @json' ./Assets/asset-config-map.yaml | while read -r line; do
            input=$(echo "$line" | jq -r '.input')
            png=$(echo "$line" | jq -r '.png // "null"')
            pdf=$(echo "$line" | jq -r '.pdf // "null"')

            echo "Processing: $input"
            echo "PNG config: $png"
            echo "PDF config: $pdf"

            # Get the base filename from input (without path)
            input_basename=$(basename "$input")
            # Get the directory containing the input file
            input_dir=$(dirname "$input")

            # Process PNG if configured
            if [ "$png" != "null" ] && [ -n "$png" ]; then
              # If png ends with /, it's a directory - append the filename
              if [[ "$png" == */ ]]; then
                # Resolve the output directory path relative to input directory
                png_dir_abs=$(cd "$input_dir" && realpath "$png")
              else
                # Resolve the full output path relative to input directory  
                png_dir_abs=$(cd "$input_dir" && dirname "$(realpath "$png")")
              fi
              
              # Convert to relative path for Docker
              png_dir_rel=$(realpath --relative-to="$PWD" "$png_dir_abs")
              
              # Final output filename (keeping .drawio in the name)
              final_png="${png_dir_abs}/${input_basename}.png"
              final_png_rel=$(realpath --relative-to="$PWD" "$final_png")
              
              mkdir -p "$png_dir_abs"
              echo "Converting to PNG: $final_png_rel"
              
              # Remove existing file if present to avoid conflicts
              rm -f "$final_png"
              
              # Export to directory (generates default-named file)
              docker run --rm \
                -v "$PWD:/data" \
                rlespinasse/drawio-export \
                --format png \
                --output "/data/$png_dir_rel" \
                "/data/$input"
              
              # Rename the generated file to our desired name
              # Docker creates files like "WiringDiagram-Page-1.png" or "Stage Diagram-Stage-Diagram.png"
              # We need to find these and rename to "WiringDiagram.drawio.png"
              input_name_without_ext="${input_basename%.drawio}"
              generated_file=$(find "$png_dir_abs" -maxdepth 1 -type f -name "${input_name_without_ext}-*.png" | head -n 1)
              if [ -n "$generated_file" ]; then
                mv "$generated_file" "$final_png"
                echo "Exported to: $final_png_rel"
              else
                echo "Warning: Could not find generated PNG file matching pattern ${input_name_without_ext}-*.png"
              fi
            else
              echo "PNG config not specified, skipping PNG conversion"
            fi

            # Process PDF if configured
            if [ "$pdf" != "null" ] && [ -n "$pdf" ]; then
              # If pdf ends with /, it's a directory - append the filename
              if [[ "$pdf" == */ ]]; then
                # Resolve the output directory path relative to input directory
                pdf_dir_abs=$(cd "$input_dir" && realpath "$pdf")
              else
                # Resolve the full output path relative to input directory
                pdf_dir_abs=$(cd "$input_dir" && dirname "$(realpath "$pdf")")
              fi
              
              # Convert to relative path for Docker
              pdf_dir_rel=$(realpath --relative-to="$PWD" "$pdf_dir_abs")
              
              # Final output filename (keeping .drawio in the name)
              final_pdf="${pdf_dir_abs}/${input_basename}.pdf"
              final_pdf_rel=$(realpath --relative-to="$PWD" "$final_pdf")
              
              mkdir -p "$pdf_dir_abs"
              echo "Converting to PDF: $final_pdf_rel"
              
              # Remove existing file if present to avoid conflicts
              rm -f "$final_pdf"
              
              # Export to directory (generates default-named file)
              docker run --rm \
                -v "$PWD:/data" \
                rlespinasse/drawio-export \
                --format pdf \
                --output "/data/$pdf_dir_rel" \
                "/data/$input"
              
              # Rename the generated file to our desired name
              # Docker creates files like "TrailerLoadMap-Page-1.pdf" or "Stage Diagram-Stage-Diagram.pdf"
              # We need to find these and rename to "TrailerLoadMap.drawio.pdf"
              input_name_without_ext="${input_basename%.drawio}"
              generated_file=$(find "$pdf_dir_abs" -maxdepth 1 -type f -name "${input_name_without_ext}-*.pdf" | head -n 1)
              if [ -n "$generated_file" ]; then
                mv "$generated_file" "$final_pdf"
                echo "Exported to: $final_pdf_rel"
              else
                echo "Warning: Could not find generated PDF file matching pattern ${input_name_without_ext}-*.pdf"
              fi
            else
              echo "PDF config not specified, skipping PDF conversion"
            fi

            tree

          done

      - name: Commit files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Automatically converted all .drawio files to PNG and PDF and committed the results
          commit_user_name: ${{ vars.COMMIT_USER_NAME }}
          commit_user_email: ${{ vars.COMMIT_USER_EMAIL }}
          commit_author: ${{ vars.COMMIT_AUTHOR }}
          push_options: '--force'
